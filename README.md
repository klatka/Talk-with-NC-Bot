# Nextcloud Talk Bot

[![hacs_badge](https://img.shields.io/badge/HACS-Custom-41BDF5.svg?style=for-the-badge)](https://github.com/hacs/integration)
![Version](https://img.shields.io/github/v/release/klatka/nc-talk-bot-component?style=for-the-badge)

Custom component for Home Assistant to communicate between Home Assistant and Nextcloud Talk.

## What can I do with this component?

Send a message from Home Assistant to a room in Nextcloud Talk to send updates or alerts and so on.
React to messages sent in this room and do some stuff like open the garage door if somebody is asking.

You can choose if you want to communicate one way or in both ways.

## Requirements

- Nextcloud >= 27.1
- Nextcloud Talk >= 17.1

Base endpoint is: `/ocs/v2.php/apps/spreed/api/v1`: (requires the bots-v1 capability - available since Nextcloud 27.1)

## Install

1. Install this component in Home Assistant:

   Add this repository to HACS

   Install nctalkbot in HACS

   Restart Home Assistant

### Send messages only (One-way communication)

2. Create a bot in Nextcloud Talk (see [nextcloud docs](https://nextcloud-talk.readthedocs.io/en/latest/bots/)):

   Use [occ](https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/occ_command.html) to create a new bot:

   ```shell
   occ talk:bot:install -f response "<name>" "<shared_secret>" "<webhook_url>" "[<description>]"
   ```

   Note: `webhook_url` must be a valid URL. Even if you explicitly leave out the webhook feature like above. Be aware that if you enable the webhook feature, all your messages will be sent to this URL.

   Get the id of the created bot:

   ```shell
   occ talk:bot:list
   ```

   Create a room in Nextcloud Talk (you get the room token within the response):

   ```shell
   occ talk:room:create --user <your_uid> --owner <your_uid> <room_name>
   ```

   Assign bot to this room:

   ```shell
   occ talk:bot:setup <bot_id> <room_token>
   ```

3. Add this to your `configuration.yaml`:

   ```yaml
   notify:
     - platform: nctalkbot
       name: nctalkbot
       url: !secret nextcloud_url
       shared_secret: !secret nextcloud_talk_shared_secret
       room_token: !secret nextcloud_talk_room_token
   ```

   Add needed secrets in your `secrets.yaml`

   Restart Home Assistant again

### React to messages (Two-way communication)

2. Create a config entry for this component (this will create a webhook and generate a secret for you).

   You have to provide your URL to your Nextcloud instance (e.g. `https://nextcloud.local/`) and click on submit.

   The next window shows a `Webhook URL` and a `Shared secret`. You need this info for installing the Nextcloud Talk Bot.

3. Create a bot in Nextcloud Talk (see [nextcloud docs](https://nextcloud-talk.readthedocs.io/en/latest/bots/)):

   Use [occ](https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/occ_command.html) to create a new bot:

   ```shell
   occ talk:bot:install "<name>" "<shared_secret>" "<webhook_url>" "[<description>]"
   ```

   Note: Fill in the `Webhook URL` and the `Shared secret` generated by the config entry.

   Get the id of the created bot:

   ```shell
   occ talk:bot:list
   ```

   Create a room in Nextcloud Talk (you get the room token within the response):

   ```shell
   occ talk:room:create --user <your_uid> --owner <your_uid> <room_name>
   ```

   Assign bot to this room:

   ```shell
   occ talk:bot:setup <bot_id> <room_token>
   ```

4. (Optional) Add notify platform settings and secrets to your `configuration.yaml` like shown above if you want to send messages too.

   Restart Home Assistant again

## Send message

Use service `notify.nctalkbot`:

```yaml
service: notify.nctalkbot
data:
  message: Test from Home Assistant
```

If you want to target another room, you can set the room token like this:

```yaml
service: notify.nctalkbot
data:
  message: Test from Home Assistant
  target: <room-token>
```

Note: The bot must be assigned to your target room!

## React to message

Every time something happens in the Nextcloud Talk room, the webhook will be triggered.
After verifying that this is a valid message from an authorized bot the event `nctalkbot_webhook_received` will be fired.

The content of the fired event looks like this:
```
event_type: nctalkbot_webhook_received
data:
  type: Create
  actor:
    type: Person
    id: users/kevin.latka
    name: Kevin Latka
  object:
    type: Note
    id: "807"
    name: message
    content: "{\"message\":\"I love this component\",\"parameters\":[]}"
    mediaType: text/markdown
  target:
    type: Collection
    id: f7wt6tng
    name: nctalkbot
  webhook_id: bdb898075abcf8214e5a296d7f3f0d516c69c986638ab92f7baa8e929670f7bb
origin: LOCAL
time_fired: "2023-10-26T16:29:23.417885+00:00"
context:
  id: 01HDPD3C2S6C6BAEVMMRH8N18N
  parent_id: null
  user_id: null
```

At this point, you can create plenty of automation for this webhook event:
- If the message is `open garage` -> open garage in Home Assistant
- Feed assistants with the message to let them handle it
- ...

<a href="https://www.buymeacoffee.com/klatka" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/default-orange.png" alt="Buy Me a Coffee" height="41" width="174"></a>
